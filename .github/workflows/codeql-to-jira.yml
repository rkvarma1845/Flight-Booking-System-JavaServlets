name: CodeQL Findings to Jira

on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

permissions:
  security-events: read
  contents: read

jobs:
  create-jira-ticket:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Get CodeQL alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?state=open \
          > alerts.json

      - name: Create Jira tickets
        run: |
          jq -e 'type == "array"' alerts.json > /dev/null || exit 0
      
          jq -c '.[] | select(.rule != null)' alerts.json | while read alert; do
            id=$(echo "$alert" | jq -r '.number')
            title=$(echo "$alert" | jq -r '.rule.name // "CodeQL issue"')
            severity=$(echo "$alert" | jq -r '.rule.severity // "unknown"')
            file=$(echo "$alert" | jq -r '.most_recent_instance.location.path // "unknown file"')
            url=$(echo "$alert" | jq -r '.html_url')
      
            summary="CodeQL #$id â€“ $title ($file)"
      
            echo "Creating Jira ticket: $summary"
      
            curl -s -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue \
              -d "{
                \"fields\": {
                  \"project\": { \"key\": \"${{ secrets.JIRA_PROJECT_KEY }}\" },
                  \"summary\": \"$summary\",
                  \"description\": {
                    \"type\": \"doc\",
                    \"version\": 1,
                    \"content\": [{
                      \"type\": \"paragraph\",
                      \"content\": [{
                        \"type\": \"text\",
                        \"text\": \"Severity: $severity\nFile: $file\n$url\"
                      }]
                    }]
                  },
                  \"issuetype\": { \"name\": \"Bug\" }
                }
              }"
          done
      
