name: CodeQL Findings to Jira

on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

permissions:
  security-events: read
  contents: read

jobs:
  create-jira-ticket:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Get CodeQL alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching CodeQL alerts for repository: ${{ github.repository }}"

          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?state=open \
            > alerts.json

          echo "üìÑ Alerts saved to alerts.json"
          echo "üìä Total alerts found:"
          jq 'length' alerts.json || echo "‚ö†Ô∏è Failed to count alerts"

      - name: Create Jira tickets
        run: |
          echo "üöÄ Starting Jira ticket creation step"
      
          if ! jq -e 'type == "array"' alerts.json > /dev/null; then
            echo "‚ÑπÔ∏è alerts.json is not an array or empty. Exiting."
            exit 0
          fi
      
          TOTAL_ALERTS=$(jq 'length' alerts.json)
          echo "üî¢ Processing $TOTAL_ALERTS alerts"
      
          jq -r '.[] | select(.rule != null) | @base64' alerts.json | while read -r encoded; do
            decode() {
              echo "$encoded" | base64 --decode | jq -r "$1"
            }
      
            id=$(decode '.number')
            title=$(decode '.rule.description // .rule.name')
            severity=$(decode '.rule.security_severity_level // "unknown"' | tr '[:lower:]' '[:upper:]')
            status=$(decode '.state')
            file=$(decode '.most_recent_instance.location.path // "unknown file"')
            url=$(decode '.html_url')

            cwe=$(decode '
              [.rule.tags[]?
               | select(test("cwe-"))
               | sub(".*/"; "")
               | ascii_upcase]
              | join(", ")
            ')
      
            summary="CodeQL #$id ‚Äì $title ($file)"
            title_with_id="Code scanning alert #$id ‚Äì $title"
      
            echo "--------------------------------------------"
            echo "üìù Creating Jira ticket"
            echo "ID       : $id"
            echo "Title    : $title"
            echo "Severity : $severity"
            echo "Status   : $status"
            echo "CWE     : $cwe"
            echo "File     : $file"
            echo "URL      : $url"
            echo "Summary  : $summary"
            echo "--------------------------------------------"
      
            JSON_PAYLOAD=$(jq -n \
              --arg project "${{ secrets.JIRA_PROJECT_KEY }}" \
              --arg title "$title_with_id" \
              --arg summary "$summary" \
              --arg severity "$severity" \
              --arg status "$status" \
              --arg cwe "$cwe" \
              --arg file "$file" \
              --arg url "$url" \
              '{
                fields: {
                  project: { key: $project },
                  summary: $title_with_id,
                  issuetype: { name: "Bug" },
                  description: {
                    type: "doc",
                    version: 1,
                    content: [
                      {
                        type: "paragraph",
                        content: [
                          { "type": "text", "text": ("Vulnerability: " + $summary) }
                        ]
                      },
                      {
                        type: "paragraph",
                        content: [
                          { "type": "text", "text": ("Severity: " + $severity) }
                        ]
                      },
                      {
                        "type": "paragraph",
                        "content": [
                          { "type": "text", "text": "GitHub uses " },
                          {
                            "type": "text",
                            "text": "Common Vulnerability Scoring System (CVSS)",
                            "marks": [
                              {
                                "type": "link",
                                "attrs": { "href": "https://www.atlassian.com/trust/security/security-severity-levels" }
                              }
                            ]
                          },
                          { "type": "text", "text": " data to calculate security severity." }
                        ]
                      },
                      {
                        type: "paragraph",
                        content: [
                          { "type": "text", "text": ("Status: " + $status) }
                        ]
                      },
                      {
                        type: "paragraph",
                        content: [
                          {
                            "type": "text",
                            "text": (
                              "Weaknesses: " +
                              (if ($cwe | length) > 0 then $cwe else "N/A" end)
                            )
                          }
                        ]
                      },
                      {
                        type: "paragraph",
                        content: [
                          { "type": "text", "text": ("File: " + $file) }
                        ]
                      },
                      {
                        "type": "paragraph",
                        "content": [
                          {
                            "type": "text",
                            "text": "Visit the vulnerability‚Äôs "
                          },
                          {
                            "type": "text",
                            "text": "code scanning alert page in GitHub",
                            "marks": [
                              {
                                "type": "link",
                                "attrs": {
                                  "href": $url
                                }
                              }
                            ]
                          },
                          {
                            "type": "text",
                            "text": " for impact, a recommendation, and a relevant example."
                          }
                        ]
                      }
                    ]
                  }
                }
              }'
            )

            
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue \
              -d "$JSON_PAYLOAD"
            )

      
            if echo "$RESPONSE" | grep -q "HTTP_STATUS:201"; then
              echo "‚úÖ Jira ticket created successfully"
            else
              echo "‚ùå Failed to create Jira ticket"
              echo "$RESPONSE"
            fi
          done
      
          echo "üéâ Jira ticket creation process completed"
