name: CodeQL Findings to Jira

on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

permissions:
  security-events: read
  contents: read

jobs:
  create-jira-ticket:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Get CodeQL alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching CodeQL alerts for repository: ${{ github.repository }}"

          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?state=open \
            > alerts.json

          echo "üìÑ Alerts saved to alerts.json"
          echo "üìä Total alerts found:"
          jq 'length' alerts.json || echo "‚ö†Ô∏è Failed to count alerts"

      - name: Create Jira tickets
        run: |
          echo "üöÄ Starting Jira ticket creation step"

          # Check if alerts.json is an array
          if ! jq -e 'type == "array"' alerts.json > /dev/null; then
            echo "‚ÑπÔ∏è alerts.json is not an array or empty. Exiting."
            exit 0
          fi

          TOTAL_ALERTS=$(jq 'length' alerts.json)
          echo "üî¢ Processing $TOTAL_ALERTS alerts"

          jq -c '.[] | select(.rule != null)' alerts.json | while read alert; do
            id=$(echo "$alert" | jq -r '.number')
            title=$(echo "$alert" | jq -r '.rule.name // "CodeQL issue"')
            severity=$(echo "$alert" | jq -r '.rule.severity // "unknown"')
            file=$(echo "$alert" | jq -r '.most_recent_instance.location.path // "unknown file"')
            url=$(echo "$alert" | jq -r '.html_url')

            summary="CodeQL #$id ‚Äì $title ($file)"

            echo "--------------------------------------------"
            echo "üìù Creating Jira ticket"
            echo "ID       : $id"
            echo "Title    : $title"
            echo "Severity : $severity"
            echo "File     : $file"
            echo "URL      : $url"
            echo "Summary  : $summary"
            echo "--------------------------------------------"

            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue \
              -d "{
                \"fields\": {
                  \"project\": { \"key\": \"${{ secrets.JIRA_PROJECT_KEY }}\" },
                  \"summary\": \"$summary\",
                  \"description\": {
                    \"type\": \"doc\",
                    \"version\": 1,
                    \"content\": [{
                      \"type\": \"paragraph\",
                      \"content\": [{
                        \"type\": \"text\",
                        \"text\": \"Severity: $severity\nFile: $file\n$url\"
                      }]
                    }]
                  },
                  \"issuetype\": { \"name\": \"Bug\" }
                }
              }")

            echo "$RESPONSE"

            if echo "$RESPONSE" | grep -q "HTTP_STATUS:201"; then
              echo "‚úÖ Jira ticket created successfully"
            else
              echo "‚ùå Failed to create Jira ticket"
            fi

          done

          echo "üéâ Jira ticket creation process completed"
