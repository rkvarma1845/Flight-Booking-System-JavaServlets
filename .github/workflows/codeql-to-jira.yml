name: CodeQL Findings to Jira

on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

jobs:
  create-jira-ticket:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Get CodeQL alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?state=open \
          > alerts.json

      - name: Create Jira tickets for alerts
        run: |
          jq -c '.[]' alerts.json | while read alert; do
            title=$(echo $alert | jq -r '.rule.name')
            severity=$(echo $alert | jq -r '.rule.severity')
            url=$(echo $alert | jq -r '.html_url')

            curl -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue \
              -d "{
                \"fields\": {
                  \"project\": { \"key\": \"${{ secrets.JIRA_PROJECT_KEY }}\" },
                  \"summary\": \"CodeQL: $title\",
                  \"description\": {
                    \"type\": \"doc\",
                    \"version\": 1,
                    \"content\": [{
                      \"type\": \"paragraph\",
                      \"content\": [{
                        \"type\": \"text\",
                        \"text\": \"Severity: $severity\n$url\"
                      }]
                    }]
                  },
                  \"issuetype\": { \"name\": \"Bug\" }
                }
              }"
          done
